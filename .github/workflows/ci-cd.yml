name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: ghcr.io/shubhangkalkar/kubernetes-ci-cd-pipeline-with-argocd

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v2
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
      - name: Update GitOps repository
        shell: powershell
        env:
          GIT_TOKEN: ${{ secrets.GITOPS_PAT }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          SHA: ${{ github.sha }}
        run: |
          git config --global credential.helper store
          "https://$env:GIT_TOKEN:x-oauth-basic@github.com" | Out-File -FilePath "$HOME\.git-credentials" -Encoding ascii

          if (Test-Path gitops) { Remove-Item -Recurse -Force gitops }

          git clone https://github.com/ShubhangKalkar/grade-api-gitops.git gitops
          Set-Location gitops

          (Get-Content deployment.yaml) `
            -replace "image:\s*$($env:IMAGE_NAME):.*", "image: $($env:IMAGE_NAME):$($env:SHA)" |
            Set-Content deployment.yaml

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add deployment.yaml
          git commit -m "Update image to $env:SHA" 2>$null; if ($LASTEXITCODE -ne 0) { "No changes to commit" }

          git push https://$env:GIT_TOKEN@github.com/ShubhangKalkar/grade-api-gitops.git main